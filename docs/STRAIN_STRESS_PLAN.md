# Strain/Stress 계산 기능 확장 계획

## 개요

동일한 메쉬의 **변형 전(Reference)**과 **변형 후(Deformed)** 좌표를 입력받아:
1. 요소별 **변형률(Strain)** 계산
2. 선형 탄성 물성을 적용하여 요소별 **응력(Stress)** 계산
3. LS-DYNA **dynain** 포맷으로 출력

```
┌─────────────────┐     ┌─────────────────┐
│  Reference Mesh │     │  Deformed Mesh  │
│  (변형 전)       │     │  (변형 후)       │
│  동일한 topology │     │  동일한 topology │
└────────┬────────┘     └────────┬────────┘
         │                       │
         └───────────┬───────────┘
                     │
                     ▼
         ┌───────────────────────┐
         │   Strain Calculation  │
         │   (변형률 계산)        │
         └───────────┬───────────┘
                     │
                     ▼
         ┌───────────────────────┐
         │  Stress Calculation   │
         │  (응력 계산, 선택적)   │
         │  E, ν 필요            │
         └───────────┬───────────┘
                     │
                     ▼
         ┌───────────────────────┐
         │   dynain Output       │
         │   (LS-DYNA 포맷)      │
         └───────────────────────┘
```

---

## 1. 이론적 배경

### 1.1 Strain-Displacement Relation (변형률-변위 관계)

#### Small Strain (Engineering Strain)
소변형 가정 시, 변형률 텐서:

```
ε_ij = 1/2 (∂u_i/∂X_j + ∂u_j/∂X_i)
```

여기서:
- `u = x - X` : 변위 벡터
- `X` : 참조 좌표 (Reference)
- `x` : 현재 좌표 (Deformed)

#### Green-Lagrange Strain (대변형)
대변형 시, Green-Lagrange 변형률 텐서:

```
E_ij = 1/2 (∂u_i/∂X_j + ∂u_j/∂X_i + ∂u_k/∂X_i · ∂u_k/∂X_j)
     = 1/2 (F^T · F - I)
```

여기서:
- `F = ∂x/∂X` : 변형 구배 텐서 (Deformation Gradient)
- `I` : 단위 텐서

### 1.2 Constitutive Equation (구성 방정식)

#### 등방성 선형 탄성 (Isotropic Linear Elastic)

**Hooke's Law** (3D):

```
σ = C : ε
```

또는 Voigt 표기법:

```
┌ σ_xx ┐   ┌ C11 C12 C12  0   0   0  ┐ ┌ ε_xx ┐
│ σ_yy │   │ C12 C11 C12  0   0   0  │ │ ε_yy │
│ σ_zz │ = │ C12 C12 C11  0   0   0  │ │ ε_zz │
│ τ_yz │   │  0   0   0  C44  0   0  │ │ γ_yz │
│ τ_xz │   │  0   0   0   0  C44  0  │ │ γ_xz │
└ τ_xy ┘   └  0   0   0   0   0  C44 ┘ └ γ_xy ┘
```

여기서:
- `C11 = E(1-ν) / ((1+ν)(1-2ν))` : λ + 2μ
- `C12 = Eν / ((1+ν)(1-2ν))` : λ
- `C44 = E / (2(1+ν))` : μ (전단 탄성 계수)
- `E` : 영률 (Young's Modulus)
- `ν` : 푸아송비 (Poisson's Ratio)

### 1.3 HEX8 요소의 변형 구배 계산

Isoparametric HEX8 요소에서:

```
       ┌ ∂N/∂ξ ┐         ┌ ∂x/∂ξ  ∂y/∂ξ  ∂z/∂ξ  ┐
J =    │ ∂N/∂η │ · [x] = │ ∂x/∂η  ∂y/∂η  ∂z/∂η  │
       └ ∂N/∂ζ ┘         └ ∂x/∂ζ  ∂y/∂ζ  ∂z/∂ζ  ┘
```

변형 구배:
```
F = ∂x/∂X = J_deformed · J_reference^(-1)
```

Shape function derivatives (HEX8):
```
N_i(ξ,η,ζ) = 1/8 (1 + ξ_i·ξ)(1 + η_i·η)(1 + ζ_i·ζ)
```

---

## 2. 기능 명세

### 2.1 새로운 CLI 명령어: `prestress`

```bash
KooRemapper prestress [options] <ref_mesh> <def_mesh> <output>
```

**인자:**
- `ref_mesh`: 변형 전 참조 메쉬 (K-file)
- `def_mesh`: 변형 후 메쉬 (K-file, 동일 topology)
- `output`: 출력 파일 (dynain 포맷)

**옵션:**
- `--strain-type <type>`: 변형률 타입
  - `engineering` (기본): 공학적 변형률 (소변형)
  - `green`: Green-Lagrange 변형률 (대변형)
- `--E <value>`: 영률 (Pa 또는 MPa)
- `--nu <value>`: 푸아송비 (0 < ν < 0.5)
- `--part <id>`: 특정 Part에만 물성 적용
- `--output-strain`: 변형률도 출력
- `--gauss-points`: Gauss 적분점 개수 (1 또는 8, 기본: 1)

### 2.2 출력 포맷: LS-DYNA dynain

```
*KEYWORD
$
$ Generated by KooRemapper - Prestress Data
$ Reference: ref_mesh.k
$ Deformed: def_mesh.k
$ Date: 2026-01-11
$
*INITIAL_STRESS_SOLID
$#    eid    nint    nhisv    large      ics     ncomp
         1       1       0       0       0       0
$#  sigxx     sigyy     sigzz     sigxy     sigyz     sigxz
  1.0E+06   5.0E+05   5.0E+05   0.0E+00   0.0E+00   0.0E+00
$#    eps     unused    unused    unused    unused    unused
  0.0E+00   0.0E+00   0.0E+00   0.0E+00   0.0E+00   0.0E+00
...
*END
```

### 2.3 추가 출력 (선택적)

**CSV 형식 변형률/응력 데이터:**
```csv
ElementID,CenterX,CenterY,CenterZ,eps_xx,eps_yy,eps_zz,eps_xy,eps_yz,eps_xz,sig_xx,sig_yy,sig_zz,sig_xy,sig_yz,sig_xz,vonMises
1,10.5,5.2,0.5,0.001,-0.0003,-0.0003,0.0001,0.0,0.0,2.1e8,-6.3e7,-6.3e7,1.6e7,0.0,0.0,2.4e8
...
```

---

## 3. 구현 계획

### Phase 1: 핵심 계산 엔진 (필수)

| Step | 파일 | 설명 |
|------|------|------|
| 1.1 | `include/analysis/DeformationGradient.h` | 변형 구배 텐서(F) 계산 클래스 |
| 1.2 | `src/analysis/DeformationGradient.cpp` | HEX8/TET4 요소별 F 계산 구현 |
| 1.3 | `include/analysis/StrainTensor.h` | 변형률 텐서 클래스 (Engineering, Green-Lagrange) |
| 1.4 | `src/analysis/StrainTensor.cpp` | 변형률 계산 구현 |
| 1.5 | `include/analysis/StressTensor.h` | 응력 텐서 클래스 |
| 1.6 | `src/analysis/StressTensor.cpp` | Hooke's Law 적용 응력 계산 |

### Phase 2: 요소 분석기

| Step | 파일 | 설명 |
|------|------|------|
| 2.1 | `include/analysis/ElementAnalyzer.h` | 요소별 strain/stress 분석기 |
| 2.2 | `src/analysis/ElementAnalyzer.cpp` | Gauss 적분점 기반 계산 |
| 2.3 | `include/analysis/MaterialModel.h` | 재료 물성 모델 (선형 탄성) |
| 2.4 | `src/analysis/MaterialModel.cpp` | 탄성 강성 행렬 계산 |

### Phase 3: 출력 모듈

| Step | 파일 | 설명 |
|------|------|------|
| 3.1 | `include/parser/DynainWriter.h` | LS-DYNA dynain 포맷 작성기 |
| 3.2 | `src/parser/DynainWriter.cpp` | *INITIAL_STRESS_SOLID 출력 |
| 3.3 | `src/analysis/StressExporter.cpp` | CSV 출력 기능 |

### Phase 4: CLI 통합

| Step | 파일 | 설명 |
|------|------|------|
| 4.1 | `src/main.cpp` | `prestress` 명령어 추가 |
| 4.2 | 테스트 | 예제 메쉬로 검증 |

---

## 4. 클래스 설계

### 4.1 DeformationGradient

```cpp
class DeformationGradient {
public:
    // 요소의 변형 구배 텐서 계산
    static Matrix3x3 compute(
        const std::array<Vector3D, 8>& refNodes,   // 참조 좌표
        const std::array<Vector3D, 8>& defNodes,   // 현재 좌표
        double xi, double eta, double zeta         // 적분점 위치
    );

    // Jacobian 행렬 계산
    static Matrix3x3 computeJacobian(
        const std::array<Vector3D, 8>& nodes,
        double xi, double eta, double zeta
    );

    // Shape function 미분
    static std::array<Vector3D, 8> shapeFunctionDerivatives(
        double xi, double eta, double zeta
    );
};
```

### 4.2 StrainTensor

```cpp
class StrainTensor {
public:
    double xx, yy, zz;  // 수직 변형률
    double xy, yz, xz;  // 전단 변형률 (engineering: γ/2)

    // 변형 구배로부터 변형률 계산
    static StrainTensor fromDeformationGradient(
        const Matrix3x3& F,
        StrainType type  // ENGINEERING or GREEN_LAGRANGE
    );

    // 주변형률 계산
    std::array<double, 3> principalStrains() const;

    // 등가 변형률 (von Mises equivalent)
    double equivalentStrain() const;

    // Voigt 벡터 변환
    std::array<double, 6> toVoigt() const;
};
```

### 4.3 StressTensor

```cpp
class StressTensor {
public:
    double xx, yy, zz;  // 수직 응력
    double xy, yz, xz;  // 전단 응력

    // 변형률로부터 응력 계산 (선형 탄성)
    static StressTensor fromStrain(
        const StrainTensor& strain,
        double E,    // 영률
        double nu    // 푸아송비
    );

    // 주응력 계산
    std::array<double, 3> principalStresses() const;

    // von Mises 등가 응력
    double vonMises() const;

    // 수압 응력
    double hydrostaticStress() const;

    // Voigt 벡터 변환
    std::array<double, 6> toVoigt() const;
};
```

### 4.4 MaterialModel

```cpp
class MaterialModel {
public:
    enum class Type {
        LINEAR_ELASTIC,
        // 향후 확장 가능: PLASTIC, HYPERELASTIC, etc.
    };

    // 등방성 선형 탄성 생성
    static MaterialModel isotropicElastic(double E, double nu);

    // 탄성 강성 행렬 (6x6, Voigt)
    Matrix6x6 getStiffnessMatrix() const;

    // 응력 계산
    StressTensor computeStress(const StrainTensor& strain) const;

private:
    Type type_;
    double E_;   // 영률
    double nu_;  // 푸아송비
    double lambda_;  // Lamé's first parameter
    double mu_;      // Shear modulus
};
```

### 4.5 ElementAnalyzer

```cpp
class ElementAnalyzer {
public:
    struct Result {
        int elementId;
        Vector3D center;           // 요소 중심
        StrainTensor strain;       // 평균 변형률
        StressTensor stress;       // 평균 응력 (물성 제공 시)
        double vonMisesStrain;
        double vonMisesStress;
        bool isValid;
    };

    ElementAnalyzer();

    // 재료 물성 설정
    void setMaterial(const MaterialModel& material);

    // 단일 요소 분석
    Result analyzeElement(
        const Element& elem,
        const Mesh& refMesh,
        const Mesh& defMesh,
        StrainType strainType
    );

    // 전체 메쉬 분석
    std::vector<Result> analyzeMesh(
        const Mesh& refMesh,
        const Mesh& defMesh,
        StrainType strainType
    );

private:
    std::optional<MaterialModel> material_;
    int numGaussPoints_;  // 1 또는 8
};
```

---

## 5. 알고리즘 상세

### 5.1 HEX8 요소 변형률 계산 순서

```
1. 참조/변형 메쉬에서 요소의 8개 노드 좌표 추출
   refNodes[8], defNodes[8]

2. Gauss 적분점에서 계산 (1점 또는 2x2x2)
   for each gauss point (ξ, η, ζ):

   2.1 Shape function 미분 계산
       dN[8] = shapeFunctionDerivatives(ξ, η, ζ)

   2.2 참조 Jacobian 계산
       J_ref = Σ dN[i] ⊗ refNodes[i]

   2.3 변형 Jacobian 계산
       J_def = Σ dN[i] ⊗ defNodes[i]

   2.4 변형 구배 계산
       F = J_def · J_ref^(-1)

   2.5 변형률 계산
       if (Engineering):
           ε = 1/2 (F + F^T) - I
       else (Green-Lagrange):
           E = 1/2 (F^T · F - I)

3. Gauss 점들의 가중 평균으로 요소 변형률 산출

4. (물성 있으면) 응력 계산
   σ = C : ε
```

### 5.2 TET4 요소 처리

TET4는 상수 변형률 요소이므로 더 간단:

```
1. 4개 노드 좌표로 Jacobian 직접 계산
   J = [X2-X1, X3-X1, X4-X1]

2. 변형 구배
   F = J_def · J_ref^(-1)

3. 변형률/응력 계산 (동일)
```

---

## 6. dynain 출력 포맷 상세

### 6.1 *INITIAL_STRESS_SOLID

```
*INITIAL_STRESS_SOLID
$#    eid    nint    nhisv    large      ics     ncomp
       eid: 요소 ID
      nint: 적분점 개수 (보통 1)
     nhisv: 히스토리 변수 개수 (0)
     large: 대변형 플래그 (0 또는 1)
       ics: 좌표계 (0: global)
     ncomp: 응력 성분 개수 (0: default 6)

$#  sigxx     sigyy     sigzz     sigxy     sigyz     sigxz
     응력 성분 (Pa 또는 사용자 단위)

$#    eps     hisv1     hisv2     ...
     등가 소성 변형률 (탄성만이면 0)
```

### 6.2 예제 출력

```
*KEYWORD
$
$ KooRemapper Prestress Output
$ Reference: flat_mesh.k
$ Deformed: bent_mesh.k
$ Material: E=2.1e11 Pa, nu=0.3
$ Strain Type: Green-Lagrange
$ Generated: 2026-01-11 12:00:00
$
*INITIAL_STRESS_SOLID
$#    eid    nint    nhisv    large      ics     ncomp
         1       1       0       1       0       0
$#  sigxx     sigyy     sigzz     sigxy     sigyz     sigxz
 2.100E+08-6.300E+07-6.300E+07 0.000E+00 0.000E+00 0.000E+00
$#    eps
 0.000E+00
         2       1       0       1       0       0
$#  sigxx     sigyy     sigzz     sigxy     sigyz     sigxz
 1.890E+08-5.670E+07-5.670E+07 1.000E+06 0.000E+00 0.000E+00
$#    eps
 0.000E+00
...
*END
```

---

## 7. 테스트 계획

### 7.1 단위 테스트

| 테스트 | 설명 |
|--------|------|
| `test_DeformationGradient` | 단순 변형에서 F 검증 (stretch, shear) |
| `test_StrainTensor` | ε = 1/2(F+F^T)-I 검증 |
| `test_GreenLagrange` | E = 1/2(F^T·F-I) 검증 |
| `test_StressTensor` | Hooke's law σ = C:ε 검증 |
| `test_vonMises` | von Mises 등가 응력 검증 |

### 7.2 통합 테스트

| 테스트 | 입력 | 예상 결과 |
|--------|------|----------|
| 균일 인장 | 1축 10% stretch | ε_xx = 0.1, σ_xx = E×0.1 |
| 순수 전단 | γ_xy = 0.05 | τ_xy = G×0.05 |
| 굽힘 | arc30 flat→bent | 상부 압축, 하부 인장 |
| U-fold | foldable flat→bent | 굽힘부 고변형률 |

### 7.3 검증

- ANSYS/Abaqus 결과와 비교
- 해석적 해가 있는 단순 케이스 검증

---

## 8. 일정 예상

| Phase | 작업 | 예상 시간 |
|-------|------|----------|
| 1 | 핵심 계산 엔진 | 4-6 시간 |
| 2 | 요소 분석기 | 2-3 시간 |
| 3 | 출력 모듈 | 2-3 시간 |
| 4 | CLI 통합 | 1-2 시간 |
| 5 | 테스트 및 검증 | 2-3 시간 |
| **합계** | | **11-17 시간** |

---

## 9. 향후 확장 가능성

1. **비선형 물성**
   - 소성 (plasticity)
   - 초탄성 (hyperelasticity)

2. **열응력**
   - 온도 변화에 따른 열팽창 변형률

3. **다층 구조**
   - Part별 다른 물성 적용

4. **시각화**
   - VTK 출력으로 ParaView 호환

5. **역문제**
   - 목표 응력 분포로부터 초기 형상 계산

---

## 10. 참고 자료

1. Bathe, K.J. "Finite Element Procedures" - 변형률/응력 이론
2. Belytschko, T. "Nonlinear Finite Elements" - 대변형 역학
3. LS-DYNA Keyword Manual - dynain 포맷 명세
4. Cook, R.D. "Concepts and Applications of FEA" - HEX8 요소 이론

